#!/usr/bin/env ruby
require 'rubygems'
require 'bundler/setup'

require 'fileutils'

$LOAD_PATH.unshift File.expand_path("../app", __dir__)
require "vr"

FileUtils.mkdir_p "cache/fetcher"
ds = VR::Dataset.new("datasets.json")

print "Starting index\n"
ds.each do |entry|
  begin
    mapper = VR::Mapper.new(entry)
    indexer = VR::Indexer.new(entry, mapper)

    indexer.run
    print "Indexed #{entry[:name]}\n"
  rescue NameError => e
    print "Ignoring #{entry[:name]} - #{e}\n"
  end
end

OpenTelemetry.tracer_provider.shutdown
